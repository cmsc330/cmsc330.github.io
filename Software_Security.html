<!DOCTYPE html>
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>13&nbsp;Software Security</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><link rel="stylesheet" type="text/css" href="extra.css" title="default"/><link rel="stylesheet" type="text/css" href="faq.css" title="default"/><link rel="stylesheet" type="text/css" href="fancyverb.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9660;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">CMSC 330 Lecture Notes</a></td></tr></table></div><div class="tocviewsublisttop" style="display: block;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="intro.html" class="tocviewlink" data-pltdoc="x">Introduction</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="ocaml.html" class="tocviewlink" data-pltdoc="x">Functional Programming with OCaml</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="imperative-ocaml.html" class="tocviewlink" data-pltdoc="x">Imperative Programming with OCaml</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="pbt.html" class="tocviewlink" data-pltdoc="x">Property-<wbr></wbr>Based Randomized Testing (PBT)</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="regexp.html" class="tocviewlink" data-pltdoc="x">OCaml Regular Expressions</a></td></tr><tr><td align="right">6&nbsp;</td><td><a href="Finite_Automata.html" class="tocviewlink" data-pltdoc="x">Finite Automata</a></td></tr><tr><td align="right">7&nbsp;</td><td><a href="Context_Free_Grammars.html" class="tocviewlink" data-pltdoc="x">Context Free Grammars</a></td></tr><tr><td align="right">8&nbsp;</td><td><a href="Parsing.html" class="tocviewlink" data-pltdoc="x">Parsing</a></td></tr><tr><td align="right">9&nbsp;</td><td><a href="Operational_Semantics.html" class="tocviewlink" data-pltdoc="x">Operational Semantics</a></td></tr><tr><td align="right">10&nbsp;</td><td><a href="Type_Checking.html" class="tocviewlink" data-pltdoc="x">Type Checking</a></td></tr><tr><td align="right">11&nbsp;</td><td><a href="Lambda_Calculus.html" class="tocviewlink" data-pltdoc="x">Lambda Calculus</a></td></tr><tr><td align="right">12&nbsp;</td><td><a href="Rust.html" class="tocviewlink" data-pltdoc="x">Rust</a></td></tr><tr><td align="right">13&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Software Security</a></td></tr><tr><td align="right">14&nbsp;</td><td><a href="exercises.html" class="tocviewlink" data-pltdoc="x">Exercises</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9658;</a></td><td>13&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Software Security</a></td></tr></table><div class="tocviewsublistbottom" style="display: none;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">13.1&nbsp;</td><td><a href="#%28part._.Cybersecurity%29" class="tocviewlink" data-pltdoc="x">Cybersecurity</a></td></tr><tr><td align="right">13.2&nbsp;</td><td><a href="#%28part._.Threat_.Modeling%29" class="tocviewlink" data-pltdoc="x">Threat Modeling</a></td></tr><tr><td align="right">13.3&nbsp;</td><td><a href="#%28part._.Buffer_.Overflows%29" class="tocviewlink" data-pltdoc="x">Buffer Overflows</a></td></tr><tr><td align="right">13.4&nbsp;</td><td><a href="#%28part._.Defense__.Type-safe_.Languages%29" class="tocviewlink" data-pltdoc="x">Defense:<span class="mywbr"> &nbsp;</span> Type-<wbr></wbr>safe Languages</a></td></tr><tr><td align="right">13.5&nbsp;</td><td><a href="#%28part._.Command_.Injection%29" class="tocviewlink" data-pltdoc="x">Command Injection</a></td></tr><tr><td align="right">13.6&nbsp;</td><td><a href="#%28part._.Defense__.Input_.Validation%29" class="tocviewlink" data-pltdoc="x">Defense:<span class="mywbr"> &nbsp;</span> Input Validation</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">On this page:</div><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber">13.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Cybersecurity%29" class="tocsubseclink" data-pltdoc="x">Cybersecurity</a></td></tr><tr><td><span class="tocsublinknumber">13.1.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Cybersecurity_.Breaches%29" class="tocsubseclink" data-pltdoc="x">Cybersecurity Breaches</a></td></tr><tr><td><span class="tocsublinknumber">13.1.2<span class="stt">&nbsp;</span></span><a href="#%28part._.Vulnerabilities__.Security-relevant_.Defects%29" class="tocsubseclink" data-pltdoc="x">Vulnerabilities:<span class="mywbr"> &nbsp;</span> Security-<wbr></wbr>relevant Defects</a></td></tr><tr><td><span class="tocsublinknumber">13.1.2.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Kinds_of_.Vulnerability%29" class="tocsubseclink" data-pltdoc="x">Kinds of Vulnerability</a></td></tr><tr><td><span class="tocsublinknumber">13.1.2.2<span class="stt">&nbsp;</span></span><a href="#%28part._.Correctness_vs__.Security%29" class="tocsubseclink" data-pltdoc="x">Correctness vs. Security</a></td></tr><tr><td><span class="tocsublinknumber">13.1.3<span class="stt">&nbsp;</span></span><a href="#%28part._.Building_.Security_.In%29" class="tocsubseclink" data-pltdoc="x">Building Security In</a></td></tr><tr><td><span class="tocsublinknumber">13.1.3.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Adding_.Security_.On%29" class="tocsubseclink" data-pltdoc="x">Adding Security On</a></td></tr><tr><td><span class="tocsublinknumber">13.1.3.2<span class="stt">&nbsp;</span></span><a href="#%28part._.Designing_and_.Building_for_.Security__from_the_.Start%29" class="tocsubseclink" data-pltdoc="x">Designing and Building for Security, from the Start</a></td></tr><tr><td><span class="tocsublinknumber">13.2<span class="stt">&nbsp;</span></span><a href="#%28part._.Threat_.Modeling%29" class="tocsubseclink" data-pltdoc="x">Threat Modeling</a></td></tr><tr><td><span class="tocsublinknumber">13.2.1<span class="stt">&nbsp;</span></span><a href="#%28part._.The_.Lovely_and_.Dangerous_.Internet__in_.Brief%29" class="tocsubseclink" data-pltdoc="x">The Lovely and Dangerous Internet, in Brief</a></td></tr><tr><td><span class="tocsublinknumber">13.2.1.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Clients_and_.Servers%29" class="tocsubseclink" data-pltdoc="x">Clients and Servers</a></td></tr><tr><td><span class="tocsublinknumber">13.2.1.2<span class="stt">&nbsp;</span></span><a href="#%28part._.Security_.Policies%29" class="tocsubseclink" data-pltdoc="x">Security Policies</a></td></tr><tr><td><span class="tocsublinknumber">13.2.2<span class="stt">&nbsp;</span></span><a href="#%28part._.Threats_to__.Internet-connected__.Computer_.Systems%29" class="tocsubseclink" data-pltdoc="x">Threats to (Internet-<wbr></wbr>connected) Computer Systems</a></td></tr><tr><td><span class="tocsublinknumber">13.2.2.1<span class="stt">&nbsp;</span></span><a href="#%28part._.As_a_.Normal_.Client%29" class="tocsubseclink" data-pltdoc="x">As a Normal Client</a></td></tr><tr><td><span class="tocsublinknumber">13.2.2.2<span class="stt">&nbsp;</span></span><a href="#%28part._.As_a__.Man_in_the_.Middle___.M.I.T.M_%29" class="tocsubseclink" data-pltdoc="x">As a "Man in the Middle" (MITM)</a></td></tr><tr><td><span class="tocsublinknumber">13.2.2.3<span class="stt">&nbsp;</span></span><a href="#%28part._.As_a_.Co-resident_.Service_user%29" class="tocsubseclink" data-pltdoc="x">As a Co-<wbr></wbr>resident Service/<span class="mywbr"> &nbsp;</span>user</a></td></tr><tr><td><span class="tocsublinknumber">13.3<span class="stt">&nbsp;</span></span><a href="#%28part._.Buffer_.Overflows%29" class="tocsubseclink" data-pltdoc="x">Buffer Overflows</a></td></tr><tr><td><span class="tocsublinknumber">13.3.1<span class="stt">&nbsp;</span></span><a href="#%28part._.What_is_a_.Buffer_.Overflow_%29" class="tocsubseclink" data-pltdoc="x">What is a Buffer Overflow?</a></td></tr><tr><td><span class="tocsublinknumber">13.3.2<span class="stt">&nbsp;</span></span><a href="#%28part._.Example__.Out-of-.Bounds_.Read_write_in_.O.Caml%29" class="tocsubseclink" data-pltdoc="x">Example:<span class="mywbr"> &nbsp;</span> Out-<wbr></wbr>of-<wbr></wbr>Bounds Read/<span class="mywbr"> &nbsp;</span>write in OCaml</a></td></tr><tr><td><span class="tocsublinknumber">13.3.3<span class="stt">&nbsp;</span></span><a href="#%28part._.Example__.Out-of-.Bounds_.Read_write_in_.C%29" class="tocsubseclink" data-pltdoc="x">Example:<span class="mywbr"> &nbsp;</span> Out-<wbr></wbr>of-<wbr></wbr>Bounds Read/<span class="mywbr"> &nbsp;</span>write in C</a></td></tr><tr><td><span class="tocsublinknumber">13.3.4<span class="stt">&nbsp;</span></span><a href="#%28part._.Exploiting_a_.Vulnerability%29" class="tocsubseclink" data-pltdoc="x">Exploiting a Vulnerability</a></td></tr><tr><td><span class="tocsublinknumber">13.3.5<span class="stt">&nbsp;</span></span><a href="#%28part._.What_.Can_.Exploitation_.Achieve_%29" class="tocsubseclink" data-pltdoc="x">What Can Exploitation Achieve?</a></td></tr><tr><td><span class="tocsublinknumber">13.3.5.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Buffer_.Overread__.Heartbleed%29" class="tocsubseclink" data-pltdoc="x">Buffer Overread:<span class="mywbr"> &nbsp;</span> Heartbleed</a></td></tr><tr><td><span class="tocsublinknumber">13.3.5.2<span class="stt">&nbsp;</span></span><a href="#%28part._.Buffer_.Overwrite__.Morris_.Worm%29" class="tocsubseclink" data-pltdoc="x">Buffer Overwrite:<span class="mywbr"> &nbsp;</span> Morris Worm</a></td></tr><tr><td><span class="tocsublinknumber">13.3.5.2.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Code_.Injection%29" class="tocsubseclink" data-pltdoc="x">Code Injection</a></td></tr><tr><td><span class="tocsublinknumber">13.4<span class="stt">&nbsp;</span></span><a href="#%28part._.Defense__.Type-safe_.Languages%29" class="tocsubseclink" data-pltdoc="x">Defense:<span class="mywbr"> &nbsp;</span> Type-<wbr></wbr>safe Languages</a></td></tr><tr><td><span class="tocsublinknumber">13.4.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Why_.Is_.Type_.Safety_.Helpful_%29" class="tocsubseclink" data-pltdoc="x">Why Is Type Safety Helpful?</a></td></tr><tr><td><span class="tocsublinknumber">13.4.2<span class="stt">&nbsp;</span></span><a href="#%28part._.Costs_of_.Ensuring_.Type_.Safety%29" class="tocsubseclink" data-pltdoc="x">Costs of Ensuring Type Safety</a></td></tr><tr><td><span class="tocsublinknumber">13.4.2.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Array_.Bounds_.Checks_for_.Spatial_.Safety%29" class="tocsubseclink" data-pltdoc="x">Array Bounds Checks for Spatial Safety</a></td></tr><tr><td><span class="tocsublinknumber">13.4.2.2<span class="stt">&nbsp;</span></span><a href="#%28part._.Temporal_.Safety_.Violations%29" class="tocsubseclink" data-pltdoc="x">Temporal Safety Violations</a></td></tr><tr><td><span class="tocsublinknumber">13.4.2.3<span class="stt">&nbsp;</span></span><a href="#%28part._.Garbage_.Collection%29" class="tocsubseclink" data-pltdoc="x">Garbage Collection</a></td></tr><tr><td><span class="tocsublinknumber">13.4.2.4<span class="stt">&nbsp;</span></span><a href="#%28part._.Expressiveness%29" class="tocsubseclink" data-pltdoc="x">Expressiveness</a></td></tr><tr><td><span class="tocsublinknumber">13.4.2.4.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Unsafe_code_via_.Escape_.Hatches%29" class="tocsubseclink" data-pltdoc="x">Unsafe code via Escape Hatches</a></td></tr><tr><td><span class="tocsublinknumber">13.5<span class="stt">&nbsp;</span></span><a href="#%28part._.Command_.Injection%29" class="tocsubseclink" data-pltdoc="x">Command Injection</a></td></tr><tr><td><span class="tocsublinknumber">13.5.1<span class="stt">&nbsp;</span></span><a href="#%28part._.What_s_.Wrong_with_this_.Ruby_.Code_%29" class="tocsubseclink" data-pltdoc="x">What&rsquo;s Wrong with this Ruby Code?</a></td></tr><tr><td><span class="tocsublinknumber">13.5.1.1<span class="stt">&nbsp;</span></span><a href="#%28part._.The_.Answer%29" class="tocsubseclink" data-pltdoc="x">The Answer</a></td></tr><tr><td><span class="tocsublinknumber">13.5.2<span class="stt">&nbsp;</span></span><a href="#%28part._.When_could_this_be_bad_%29" class="tocsubseclink" data-pltdoc="x">When could this be bad?</a></td></tr><tr><td><span class="tocsublinknumber">13.5.2.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Command_.Injection_is_.Code_.Injection%29" class="tocsubseclink" data-pltdoc="x">Command Injection is Code Injection</a></td></tr><tr><td><span class="tocsublinknumber">13.6<span class="stt">&nbsp;</span></span><a href="#%28part._.Defense__.Input_.Validation%29" class="tocsubseclink" data-pltdoc="x">Defense:<span class="mywbr"> &nbsp;</span> Input Validation</a></td></tr><tr><td><span class="tocsublinknumber">13.6.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Checking_and_.Sanitization%29" class="tocsubseclink" data-pltdoc="x">Checking and Sanitization</a></td></tr><tr><td><span class="tocsublinknumber">13.6.1.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Blacklisting%29" class="tocsubseclink" data-pltdoc="x">Blacklisting</a></td></tr><tr><td><span class="tocsublinknumber">13.6.1.1.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Checking%29" class="tocsubseclink" data-pltdoc="x">Checking</a></td></tr><tr><td><span class="tocsublinknumber">13.6.1.1.2<span class="stt">&nbsp;</span></span><a href="#%28part._.Sanitization%29" class="tocsubseclink" data-pltdoc="x">Sanitization</a></td></tr><tr><td><span class="tocsublinknumber">13.6.1.2<span class="stt">&nbsp;</span></span><a href="#%28part._.Escaping%29" class="tocsubseclink" data-pltdoc="x">Escaping</a></td></tr><tr><td><span class="tocsublinknumber">13.6.1.2.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Escaping_is_.Language_.Specific%29" class="tocsubseclink" data-pltdoc="x">Escaping is Language Specific</a></td></tr><tr><td><span class="tocsublinknumber">13.6.1.3<span class="stt">&nbsp;</span></span><a href="#%28part._.Whitelisting%29" class="tocsubseclink" data-pltdoc="x">Whitelisting</a></td></tr><tr><td><span class="tocsublinknumber">13.6.1.3.1<span class="stt">&nbsp;</span></span><a href="#%28part._.Motivation%29" class="tocsubseclink" data-pltdoc="x">Motivation</a></td></tr><tr><td><span class="tocsublinknumber">13.6.1.3.2<span class="stt">&nbsp;</span></span><a href="#%28part._.Making_.Sure_.Input_is_.Good__not_.Bad_%29" class="tocsubseclink" data-pltdoc="x">Making Sure Input is Good (not Bad)</a></td></tr><tr><td><span class="tocsublinknumber">13.6.2<span class="stt">&nbsp;</span></span><a href="#%28part._security-summary%29" class="tocsubseclink" data-pltdoc="x">Summary</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="version">9.0</span></div><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;<span class="tocsettoggle">&nbsp;&nbsp;<a href="javascript:void(0);" title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span></span><span class="navright">&nbsp;&nbsp;<a href="Rust.html" title="backward to &quot;12 Rust&quot;" data-pltdoc="x" rel="prev">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;CMSC 330 Lecture Notes&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="exercises.html" title="forward to &quot;14 Exercises&quot;" data-pltdoc="x" rel="next">next &rarr;</a></span>&nbsp;</div><section class="SsectionLevel2" id="section 13"><h2 class="heading">13<span class="stt">&nbsp;</span><a name="(part._.Software_.Security)"></a>Software Security<span class="button-group"><a href="#(part._.Software_.Security)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h2><table cellspacing="0" cellpadding="0"><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.Cybersecurity%29" class="toclink" data-pltdoc="x">13.1<span class="hspace">&nbsp;</span>Cybersecurity</a></p></td></tr><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.Threat_.Modeling%29" class="toclink" data-pltdoc="x">13.2<span class="hspace">&nbsp;</span>Threat Modeling</a></p></td></tr><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.Buffer_.Overflows%29" class="toclink" data-pltdoc="x">13.3<span class="hspace">&nbsp;</span>Buffer Overflows</a></p></td></tr><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.Defense__.Type-safe_.Languages%29" class="toclink" data-pltdoc="x">13.4<span class="hspace">&nbsp;</span>Defense: Type-safe Languages</a></p></td></tr><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.Command_.Injection%29" class="toclink" data-pltdoc="x">13.5<span class="hspace">&nbsp;</span>Command Injection</a></p></td></tr><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.Defense__.Input_.Validation%29" class="toclink" data-pltdoc="x">13.6<span class="hspace">&nbsp;</span>Defense: Input Validation</a></p></td></tr></table><section class="SsectionLevel3" id="section 13.1"><h3 class="heading">13.1<span class="stt">&nbsp;</span><a name="(part._.Cybersecurity)"></a>Cybersecurity<span class="button-group"><a href="#(part._.Cybersecurity)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h3><section class="SsectionLevel4" id="section 13.1.1"><h4 class="heading">13.1.1<span class="stt">&nbsp;</span><a name="(part._.Cybersecurity_.Breaches)"></a>Cybersecurity Breaches<span class="button-group"><a href="#(part._.Cybersecurity_.Breaches)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>Major security breaches of computer systems are a fact of life. They affect companies, governments, and individuals. Focusing on breaches of individuals&rsquo; information, consider just a few examples:</p><ul><li><p>Equifax (2017) - 145 million consumers&rsquo; records</p></li><li><p>Adobe (2013) - 150 million records, 38 million users</p></li><li><p>eBay (2014) - 145 million records</p></li><li><p>Anthem (2014) - Records of 80 million customers</p></li><li><p>Target (2013) - 110 million records</p></li><li><p>Heartland (2008) - 160 million records</p></li></ul></section><section class="SsectionLevel4" id="section 13.1.2"><h4 class="heading">13.1.2<span class="stt">&nbsp;</span><a name="(part._.Vulnerabilities__.Security-relevant_.Defects)"></a>Vulnerabilities: Security-relevant Defects<span class="button-group"><a href="#(part._.Vulnerabilities__.Security-relevant_.Defects)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>The causes of security breaches are varied but many of them, including those given above, owe to a <span style="font-weight: bold">defect</span> (or <span style="font-style: italic">bug</span>) or <span style="font-weight: bold">design flaw</span> in a targeted computer system&rsquo;s software. The software problem can be <span style="font-weight: bold">exploited</span> by an attacker. An <span style="font-weight: bold">exploit</span> is a particular, cleverly crafted input, or a series of (usually unintuitive) interactions with the system, which trigger the bug or flaw in a way that helps the attacker.</p><section class="SsectionLevel5" id="section 13.1.2.1"><h5 class="heading">13.1.2.1<span class="stt">&nbsp;</span><a name="(part._.Kinds_of_.Vulnerability)"></a>Kinds of Vulnerability<span class="button-group"><a href="#(part._.Kinds_of_.Vulnerability)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>One obvious sort of vulnerability is a bug in security policy enforcement code. For example, suppose you are implementing an operating system and you have code to enforce access control policies on files. This is the code that makes sure that if Alice&rsquo;s policy says that only she is allowed to edit certain files, then user Bob will not be allowed to modify them. Perhaps your enforcement code failed to consider a corner case, and as a result Bob is able to write those files even though Alice&rsquo;s policy says he shouldn&rsquo;t. This is a vulnerability.</p><p>A more surprising sort of vulnerability is a bug in code that seems to have nothing to do with enforcing security all. Nevertheless, by exploiting it the attacker can break security anyway. Exploits of such bugs have fun names such as <span style="font-weight: bold">buffer overflow</span>, <span style="font-weight: bold">SQL injection</span>, <span style="font-weight: bold">cross-site scripting (XSS)</span>, <span style="font-weight: bold">command injection</span>, among many more. We&rsquo;ll talk about these and others in this part of the course.</p></section><section class="SsectionLevel5" id="section 13.1.2.2"><h5 class="heading">13.1.2.2<span class="stt">&nbsp;</span><a name="(part._.Correctness_vs__.Security)"></a>Correctness vs. Security<span class="button-group"><a href="#(part._.Correctness_vs__.Security)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>The bugs underlying security exploits are, under normal circumstances, irritating. A normal user who stumbles across them will experience a crash or incorrect behavior.</p><p>But a key thing to observe is that <span style="font-weight: bold">an attacker is not a normal user!</span></p><p>A <span style="font-style: italic">normal user</span> will attempt to <span style="font-style: italic">avoid</span> triggering software defects, and when they do trigger them, the <span style="font-style: italic">effects</span> are oftentimes <span style="font-style: italic">benign</span>.</p><p>An <span style="font-style: italic">attacker</span> will actively attempt to <span style="font-style: italic">find</span> defects, using unusual interactions and features. When they find them, they will try to <span style="font-style: italic">exploit</span> them, to <span style="font-style: italic">deleterious effect.</span></p><p>Code that is material to a system&rsquo;s secure operation is called its <span style="font-weight: bold">trusted computing base</span> (TCB). This is the code that <span style="font-style: italic">must</span> be correct if the security of the entire system is to be assured. Not all code is part of the TCB. For example, perhaps your implementation of the <span style="font-weight: bold"><span class="stt">ls</span></span> command in your operating system mis-formats some of its output. This is irritating, but it doesn&rsquo;t compromise the operating system&rsquo;s security.</p><p>Thus, while it&rsquo;s expected that software will have bugs even after it&rsquo;s deployed (perfection is expensive!), bugs in the TCB are more problematic. These are bugs that an attacker will exploit to compromise your system, causing potentially significant damage. And these bugs can be in surprising places.</p></section></section><section class="SsectionLevel4" id="section 13.1.3"><h4 class="heading">13.1.3<span class="stt">&nbsp;</span><a name="(part._.Building_.Security_.In)"></a>Building Security In<span class="button-group"><a href="#(part._.Building_.Security_.In)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>What can we do about software that has vulnerabilities?</p><section class="SsectionLevel5" id="section 13.1.3.1"><h5 class="heading">13.1.3.1<span class="stt">&nbsp;</span><a name="(part._.Adding_.Security_.On)"></a>Adding Security On<span class="button-group"><a href="#(part._.Adding_.Security_.On)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>Security companies like Symantec, McAfee, FireEye, Cisco, Kaspersky, Tenable, and others propose to deal with vulnerabilities by providing a service that runs alongside target software. Their approach is to <span style="font-style: italic">add a layer of security on top of the software, separate from it.</span></p><p>For example, you can buy services that monitor your system and prevent vulnerabilities in resident software from being exploited. Or these services may attempt to mitigate the impact of exploitation. For example, a very specific kind of input may be required to exploit a vulnerability, and the security monitoring system can look for inputs like it, as defined by a <span style="font-style: italic">signature</span>. If an input matches the signature, the security system can block or modify it and thus stop the exploit.</p><p>But there are two problems with this approach:</p><ul><li><p>It is <span style="font-style: italic">retrospective</span>. It can only work once the vulnerability, and an exploit for it, is known. Then we can make a signature that blocks the exploit. Until the vulnerability is discovered and a signature is made for it, attackers will be able to successfully (and surreptitiously) exploit it.</p></li><li><p>It is <span style="font-style: italic">not (always) general</span>. Oftentimes there are many possible inputs that can exploit a vulnerability, and they may not all be described with an efficiently recognizable signature. As such, an attacker can bypass the monitoring system by making a change to the exploit that does not match the signature but still achieves the desired effect.</p></li></ul><p>In sum: While security monitoring is useful, it has not proven it to be effective at (completely) solving the security problem. There is more to do.</p></section><section class="SsectionLevel5" id="section 13.1.3.2"><h5 class="heading">13.1.3.2<span class="stt">&nbsp;</span><a name="(part._.Designing_and_.Building_for_.Security__from_the_.Start)"></a>Designing and Building for Security, from the Start<span class="button-group"><a href="#(part._.Designing_and_.Building_for_.Security__from_the_.Start)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>A more direct (and complementary) way of dealing with vulnerabilities is to avoid introducing them in the first place, when designing and writing the software. We call this approach <span style="font-weight: bold">Building Security In</span>. It requires that every software developer (this means you!) knows something about security and writes their code with a security mindset.</p><p>At a high level, building a system with a security mindset involves doing two things:</p><ul><li><p><span style="font-weight: bold">Model threats</span>. We need to think a little bit about how an attacker could influence or observe how our code is run. The process will clarify what we can assume about the trustworthiness of inputs our code receives, and the visibility of outputs our code produces (or how it produces them).</p></li><li><p><span style="font-weight: bold">Employ Defensive</span> <span style="font-style: italic"><span style="font-weight: bold">Design Patterns</span></span>. Based on the identified threats, we apply tried-and-true <span style="font-style: italic">design patterns</span> to defend against them. A design pattern is a kind of code template that we customize to the specifics of our software or situation. Sometimes this code pattern can be automatically introduced by a language, compiler, or framework, or we may need to write the code and customize the template ourselves.</p></li></ul><p>In the rest of this lecture, we will cover three broad topics:</p><ul><li><p>The basics of <span style="font-style: italic">threat modeling</span>.</p></li><li><p>Two kinds of <span style="font-style: italic">exploits</span>: <span style="font-weight: bold">Buffer overflows</span> and <span style="font-weight: bold">command injection</span>. Both of these are instances of the more general exploit pattern of <span style="font-weight: bold">code injection</span>, which we see again in the next lecture in the form of <span style="font-style: italic">SQL injection</span> and <span style="font-style: italic">cross-site scripting</span>.</p></li><li><p>Two kinds of <span style="font-style: italic">defense</span>: <span style="font-weight: bold">Type-safe programming languages</span>, and <span style="font-weight: bold">input validation</span>. The use of the former blocks buffer overflows and many other exploits. The latter is a design pattern often programmed by hand which aims to ensure that data influenced by a potential attacker cannot force our code to do the wrong thing. It defends against buffer overflows (when not already using a type-safe language), command injection, and many other code injection exploits.</p></li></ul></section></section></section><section class="SsectionLevel3" id="section 13.2"><h3 class="heading">13.2<span class="stt">&nbsp;</span><a name="(part._.Threat_.Modeling)"></a>Threat Modeling<span class="button-group"><a href="#(part._.Threat_.Modeling)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h3><table cellspacing="0" cellpadding="0"><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.The_.Lovely_and_.Dangerous_.Internet__in_.Brief%29" class="toclink" data-pltdoc="x">13.2.1<span class="hspace">&nbsp;</span>The Lovely and Dangerous Internet, in Brief</a></p></td></tr><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.Threats_to__.Internet-connected__.Computer_.Systems%29" class="toclink" data-pltdoc="x">13.2.2<span class="hspace">&nbsp;</span>Threats to (Internet-connected) Computer Systems</a></p></td></tr></table><p>Avoiding attacks means understanding what attackers can do, and putting mechanisms in place to stop them from doing things you don&rsquo;t want. Broadly speaking, this is the process of <span style="font-style: italic">threat modeling</span>.</p><section class="SsectionLevel4" id="section 13.2.1"><h4 class="heading">13.2.1<span class="stt">&nbsp;</span><a name="(part._.The_.Lovely_and_.Dangerous_.Internet__in_.Brief)"></a>The Lovely and Dangerous Internet, in Brief<span class="button-group"><a href="#(part._.The_.Lovely_and_.Dangerous_.Internet__in_.Brief)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>For those interested in widespread, diverse, and innovative services and information, the Internet is an incredible blessing. For those aiming to defend services from attack, the Internet is a curse. This is because the Internet makes services available to just about anyone, oftentimes without any sort of accountability &#8212;<wbr></wbr> potential attackers can probe and prod many Internet services essentially without risk. Understanding what they can do is important for writing software accessible via the Internet. If you think your software won&rsquo;t be connected to the Internet, you might think again; sooner or later it will end up there.</p><section class="SsectionLevel5" id="section 13.2.1.1"><h5 class="heading">13.2.1.1<span class="stt">&nbsp;</span><a name="(part._.Clients_and_.Servers)"></a>Clients and Servers<span class="button-group"><a href="#(part._.Clients_and_.Servers)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>Most sessions over the internet can view as a simplified interaction between clients and servers.</p><ul><li><p>The <span style="font-style: italic">client</span> seeks to use a network-connected services, e.g., using a web browser, ssh client, specialized app, etc. to exchange messages with that service, over the Internet</p></li><li><p>Services are provided by a remote machine called the <span style="font-style: italic">server.</span> Oftentimes there is a pool of such machines, but the client won&rsquo;t necessarily see that &#8212;<wbr></wbr> they just visit store.com, not realizing that each interaction might go to a different server on a different machine.</p></li></ul><p>Both the client and server have resources that need protection.</p><p>The client may be on a machine with personal financial information, private records, browsing history, etc. The server will host valuable information as part of the service it is offering, such as bank account balances, student grades, personnel records, etc. Even the computing resources themselves may be valuable; e.g., an attacker could attempt to surreptitiously use a client&rsquo;s machine to send spam or carry out illicit activities.</p></section><section class="SsectionLevel5" id="section 13.2.1.2"><h5 class="heading">13.2.1.2<span class="stt">&nbsp;</span><a name="(part._.Security_.Policies)"></a>Security Policies<span class="button-group"><a href="#(part._.Security_.Policies)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>The client and server resources warrant, roughly speaking, three kinds of protection:</p><ul><li><p><span style="font-weight: bold">Confidentiality</span>. A confidentiality (aka privacy) policy states that a resource should not be readable by just anyone. Only certain users/actors should have access to the information. For example, my personal information, whether stored at a client or server, should be kept private, and not be leaked.</p></li><li><p><span style="font-weight: bold">Integrity</span>. An integrity policy indicates which parties may add to or modify a resource. For example, my bank account balance should be changeable only by me or the bank, and the change should only be via agreed-upon mechanisms, e.g., deposits or withdrawals, or certain fees.</p></li><li><p><span style="font-weight: bold">Availability</span>. An availability policy states that protected resources should not be unreasonably inaccessible. Having money at the bank but then not being able to access it for a long period would be a violation of availability. If an attacker managed to get an account on my machine and started using it to send spam, that would also be a violation of availability, because now (some of) my machine is not available for my own use.</p></li></ul><p>We will see that by exploiting software vulnerabilities, attackers are able to violate any and all of these policies.</p></section></section><section class="SsectionLevel4" id="section 13.2.2"><h4 class="heading">13.2.2<span class="stt">&nbsp;</span><a name="(part._.Threats_to__.Internet-connected__.Computer_.Systems)"></a>Threats to (Internet-connected) Computer Systems<span class="button-group"><a href="#(part._.Threats_to__.Internet-connected__.Computer_.Systems)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>What are the ways that an attacker can cause problems? These three are typical.</p><section class="SsectionLevel5" id="section 13.2.2.1"><h5 class="heading">13.2.2.1<span class="stt">&nbsp;</span><a name="(part._.As_a_.Normal_.Client)"></a>As a Normal Client<span class="button-group"><a href="#(part._.As_a_.Normal_.Client)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>An attacker can interact with an Internet service via the same channel allotted to normal users. If a normal user of an on-line store browse the store&rsquo;s products, make purchases, leave reviews, submit support requests, etc. then so can an attacker.</p><p>Of course, an attacker will attempt to perform these actions in weird and wonderful ways in an attempt to exploit potential vulnerabilities. Attackers will not limit themselves to using standard tools and will not follow instructions. For example:</p><ul><li><p>Instead of using an Internet browser, an attacker may craft network messages by hand, perhaps ones that are too long or use unusual characters.</p></li><li><p>Instead of always following the expected process, the attacker will try things that are off the beaten path. For example, rather than go to store.com via a browser, and then type in a username/password, and then click a link to go to a page, the attacker may skip the login page entirely and just type in the URL of the desired page, to attempt to bypass the authentication process.</p></li></ul><p>Thus, designers and implementers of computer systems need to think about the limits of what is possible, not just what is expected, to properly defend against a malicious client.</p></section><section class="SsectionLevel5" id="section 13.2.2.2"><h5 class="heading">13.2.2.2<span class="stt">&nbsp;</span><a name="(part._.As_a__.Man_in_the_.Middle___.M.I.T.M_)"></a>As a "Man in the Middle" (MITM)<span class="button-group"><a href="#(part._.As_a__.Man_in_the_.Middle___.M.I.T.M_)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>Normal clients can send messages to and from the server, but are normally oblivious to the interactions the server might be having with other clients. A more powerful kind of attacker can observe such interactions and potentially corrupt or manipulate them. Traditionally, such an attacker is called a Man in the Middle (MITM) because they can sit in between two (or more) communicating parties.</p><p>This sort of situation is more common than you might think because of the prevalence of wireless networks. It is not hard to observe messages being sent around on that network, since it uses a broadcast medium. If you are connected to the public network at a coffee shop, then someone else connected to that same network may be looking at the messages you send and receive.</p><p>The typical defense against this kind of attacker is to use cryptography. By using <span style="font-style: italic">encryption</span>, even if the attacker can see your messages, they can&rsquo;t make sense of them (ensures confidentiality). By using <span style="font-style: italic">digital signatures</span> (<span style="font-style: italic">aka</span> <a href="https://en.wikipedia.org/wiki/Message_authentication_code">message authentication codes</a>, or <span style="font-style: italic">MAC</span>s), even if the attacker can modify your messages, the receiver will be able to detect the modifications (ensures integrity). Additional defenses are also sometimes required, e.g., the use of <span style="font-style: italic">nonces</span> to detect the potential <span style="font-style: italic">replay</span> of messages.</p><p>We will not discuss cryptography or MITM-style attacks in this course. If you are interested in learning more, check out <a href="https://academiccatalog.umd.edu/search/?P=CMSC456">CMSC 456</a> and <a href="https://academiccatalog.umd.edu/search/?P=CMSC414">CMSC 414</a>.</p></section><section class="SsectionLevel5" id="section 13.2.2.3"><h5 class="heading">13.2.2.3<span class="stt">&nbsp;</span><a name="(part._.As_a_.Co-resident_.Service_user)"></a>As a Co-resident Service/user<span class="button-group"><a href="#(part._.As_a_.Co-resident_.Service_user)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>Sometimes an attacker can do more than just communicate via the same network as the target; they can have direct access to the same machine.</p><p>In multi-user operating systems, such as Linux or MacOs, an attacker can log in as one user in an attempt to steal or manipulate information belonging to another. In today&rsquo;s cloud computing environments, like Microsoft&rsquo;s Azure or Amazon&rsquo;s Web Services (AWS), a target may be running a <a href="https://en.wikipedia.org/wiki/System_virtual_machine">virtual machine</a> instance on the same host as one run by the attacker. Mobile code technologies enable attacker-provided code to run directly on the target machine. For example, an attacker could try to upload a malicious Javascript program to a web site that is visited by a potential victim, who will unknowingly download and run the program in their browser when they visit the site.</p><p>In these cases, co-residency means an attacker can observe or modify resources shared or even directly
owned by the target, such as memory or stable storage (files), in such a way as to achieve his goals.</p></section></section></section><section class="SsectionLevel3" id="section 13.3"><h3 class="heading">13.3<span class="stt">&nbsp;</span><a name="(part._.Buffer_.Overflows)"></a>Buffer Overflows<span class="button-group"><a href="#(part._.Buffer_.Overflows)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h3><table cellspacing="0" cellpadding="0"><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.What_is_a_.Buffer_.Overflow_%29" class="toclink" data-pltdoc="x">13.3.1<span class="hspace">&nbsp;</span>What is a Buffer Overflow?</a></p></td></tr><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.Example__.Out-of-.Bounds_.Read_write_in_.O.Caml%29" class="toclink" data-pltdoc="x">13.3.2<span class="hspace">&nbsp;</span>Example: Out-of-Bounds Read/write in OCaml</a></p></td></tr><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.Example__.Out-of-.Bounds_.Read_write_in_.C%29" class="toclink" data-pltdoc="x">13.3.3<span class="hspace">&nbsp;</span>Example: Out-of-Bounds Read/write in C</a></p></td></tr><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.Exploiting_a_.Vulnerability%29" class="toclink" data-pltdoc="x">13.3.4<span class="hspace">&nbsp;</span>Exploiting a Vulnerability</a></p></td></tr><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.What_.Can_.Exploitation_.Achieve_%29" class="toclink" data-pltdoc="x">13.3.5<span class="hspace">&nbsp;</span>What Can Exploitation Achieve?</a></p></td></tr></table><section class="SsectionLevel4" id="section 13.3.1"><h4 class="heading">13.3.1<span class="stt">&nbsp;</span><a name="(part._.What_is_a_.Buffer_.Overflow_)"></a>What is a Buffer Overflow?<span class="button-group"><a href="#(part._.What_is_a_.Buffer_.Overflow_)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>A <span style="font-style: italic">buffer overflow</span> describes a family of possible exploits of a vulnerability in which a program may incorrectly access a buffer outside its allotted bounds. A <span style="font-style: italic">buffer overwrite</span> occurs when the out-of-bounds access is a write. A <span style="font-style: italic">buffer overread</span> occurs when the access is a read.</p><p>The key question is: <span style="font-weight: bold">What happens when an out-of-bounds access occurs?</span></p><p>If your program is written in a <a href="http://www.pl-enthusiast.net/2014/07/21/memory-safety/">memory-safe</a> or <a href="http://www.pl-enthusiast.net/2014/08/05/type-safety/">type-safe</a> programming language, some important attacks are taken off the table; if it is not, then there are fairly dire security implications, as we will see.</p></section><section class="SsectionLevel4" id="section 13.3.2"><h4 class="heading">13.3.2<span class="stt">&nbsp;</span><a name="(part._.Example__.Out-of-.Bounds_.Read_write_in_.O.Caml)"></a>Example: Out-of-Bounds Read/write in OCaml<span class="button-group"><a href="#(part._.Example__.Out-of-.Bounds_.Read_write_in_.O.Caml)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>Consider the following simple program, written in <a href="https://ocaml.org/">OCaml</a>. There&rsquo;s a bug in this code; can you spot it?</p><p><div class='fancy-box'><div class="sourceCode" id="cb1"><pre
class="sourceCode ocaml"><code class="sourceCode ocaml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="kw">rec</span> incr_arr x i len =</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> i &gt;= <span class="dv">0</span> &amp;&amp; i &lt; len <span class="kw">then</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    (x.(i) &lt;- x.(i) + <span class="dv">1</span>;</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    incr_arr x (i+<span class="dv">1</span>) len)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>;;</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> y = <span class="dt">Array</span>.make <span class="dv">10</span> <span class="dv">1</span>;;</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>incr_arr y <span class="dv">0</span> (<span class="dv">1</span> + <span class="dt">Array</span>.length y);;</span></code></pre></div>
</div></p><p>The function <span class="stt">incr_arr</span> iterates over an <a href="https://ocaml.org/releases/4.07/htmlman/libref/Array.html">OCaml array</a>, adding <span class="stt">1</span> to each of its elements. The code creates an array <span class="stt">y</span> of size 10, with each element initialized to 1. It then calls <span class="stt">incr_arr</span> on this array. What happens?</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">Exception: Invalid_argument "index out of bounds".</span></p></td></tr></table></p><p>The bug is on line 8: the code should pass <span class="stt">Array.length y</span> as the third argument to <span class="stt">incr_arr</span>, but instead passes that expression, plus 1. As such, <span class="stt">incr_arr</span> will read (and attempt to write) one past the end of the array, which the program detects and signals by throwing an exception.</p></section><section class="SsectionLevel4" id="section 13.3.3"><h4 class="heading">13.3.3<span class="stt">&nbsp;</span><a name="(part._.Example__.Out-of-.Bounds_.Read_write_in_.C)"></a>Example: Out-of-Bounds Read/write in C<span class="button-group"><a href="#(part._.Example__.Out-of-.Bounds_.Read_write_in_.C)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>Here&rsquo;s our buggy example again but this time written in C.</p><p><div class='fancy-box'><div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> incr_arr<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>x<span class="op">,</span> <span class="dt">int</span> len<span class="op">,</span> <span class="dt">int</span> i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>i <span class="op">&gt;=</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> i <span class="op">&lt;</span> len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    x<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> x<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    incr_arr<span class="op">(</span>x<span class="op">,</span>len<span class="op">,</span>i<span class="op">+</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> y<span class="op">[</span><span class="dv">10</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">};</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> z <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>argv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  incr_arr<span class="op">(</span>y<span class="op">,</span><span class="dv">11</span><span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st"> =? 20</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span>z<span class="op">);</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div></p><p>As in the OCaml version, the code in <span class="stt">main</span> invokes <span class="stt">incr_arr</span> with array <span class="stt">y</span>, but after calling the function, <span class="stt">main</span> also prints out the value of another variable, <span class="stt">z</span>. As in the OCaml version, the array <span class="stt">y</span> that is being passed to <span class="stt">incr_arr</span> has length 10, but the second argument is given as 11, which is one more than it should be. As a result, line 5 will be allowed to read/write past the end of the array.</p><p>In our OCaml version, running the program resulted in an exception being thrown; what will happen in this C version?</p><p>I can compile this program with the <span class="stt">clang</span> C compiler (no optimizations) on my Mac to produce the executable <span class="stt">a.out</span>. When I run <span class="stt">a.out</span>, it completes normally, outputting the following:</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">21 =? 20</span></p></td></tr></table></p><p>What happened?</p><p>Basically, when <span class="stt">incr_arr</span> read <span class="stt">x[10]</span> on line 5 (i.e., when argument <span class="stt">i == 10</span>), the function read the contents (<span class="stt">20</span>) of <span class="stt">z</span>, since it happens to be allocated in memory just past the end of <span class="stt">y</span> (the memory that <span class="stt">x</span> is pointing to). Then line 5 added 1 to what it read, and wrote the result (<span class="stt">21</span>) back to <span class="stt">z</span>, which is printed by <span class="stt">main</span>.</p><p>When we fix the bug (by changing line 14 to be <span class="stt">incr_arr(y,10,0);</span>), the program prints the following instead, since <span class="stt">z</span> is no longer modified:</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">20 =? 20</span></p></td></tr></table></p><p>To recap: In OCaml, reading/writing outside the bounds of a buffer <span style="font-style: italic">always</span> results in an exception, and the program halts. In C, reading/writing outside the bounds of the buffer is <span style="font-style: italic">not</span> guaranteed to cause an exception. Instead, basically anything could happen. Here, we saw that adjacent memory can be read or modified.</p></section><section class="SsectionLevel4" id="section 13.3.4"><h4 class="heading">13.3.4<span class="stt">&nbsp;</span><a name="(part._.Exploiting_a_.Vulnerability)"></a>Exploiting a Vulnerability<span class="button-group"><a href="#(part._.Exploiting_a_.Vulnerability)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>When an application has a bug in it that allows the program to access a buffer outside its bounds, an attacker can try to exploit it. He does this by controlling the input to the program in a way that triggers the bug to his advantage.</p><p>In our example, the program always fails, so that&rsquo;s not very interesting. But what if we changed <span class="stt">main</span> to be the following?</p><p><div class='fancy-box'><div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>argv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> len <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>argc <span class="op">==</span> <span class="dv">2</span><span class="op">)</span> len <span class="op">=</span> atoi<span class="op">(</span>argv<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  incr_arr<span class="op">(</span>y<span class="op">,</span>len<span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st"> =? 20</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span>z<span class="op">);</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div></p><p>If we run the compiled program <span class="stt">a.out</span> with no arguments, then it works as expected (the guard on line 4 is false). But suppose we run it thusly.</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">a.out 11</span></p></td></tr></table></p><p>Since <span class="stt">argc == 2</span>, the guard on line 4 is true so it sets <span class="stt">len</span> to be 11. Thus the call to <span class="stt">incr_arr</span> on line 5 is the same buggy one we saw in the original version of our buggy C program, and <span class="stt">z</span> will be overwritten.</p><p>An attacker can exploit the bug if he can influence what (and whether) the argument is passed to <span class="stt">a.out</span>. If he can force the argument to be 11 (or more), then he can trigger the bug.</p></section><section class="SsectionLevel4" id="section 13.3.5"><h4 class="heading">13.3.5<span class="stt">&nbsp;</span><a name="(part._.What_.Can_.Exploitation_.Achieve_)"></a>What Can Exploitation Achieve?<span class="button-group"><a href="#(part._.What_.Can_.Exploitation_.Achieve_)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>To recap: Suppose my program has a bug in it that allows reading or writing outside the bounds of a buffer, and the attacker is able to control that happening, at least to some degree. What can the attacker achieve?</p><section class="SsectionLevel5" id="section 13.3.5.1"><h5 class="heading">13.3.5.1<span class="stt">&nbsp;</span><a name="(part._.Buffer_.Overread__.Heartbleed)"></a>Buffer Overread: Heartbleed<span class="button-group"><a href="#(part._.Buffer_.Overread__.Heartbleed)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p><span style="font-style: italic">Heartbleed</span> is a bug in the popular, open-source <a href="https://www.openssl.org/">OpenSSL</a> codebase that is used by a substantial number of Internet clients and servers to carry out secure communication, e.g., as part of the <a href="https://en.wikipedia.org/wiki/HTTPS">HTTPS protocol</a>. By <a href="https://twitter.com/colmmacc/status/1114951109825658881?s=20">one account</a>, Heartbleed "made more headlines and news articles in one day than any war had since Vietnam." Now it has its <a href="https://heartbleed.com/">own website</a>!</p><p>This XKCD comic explains it very well:</p><p><img src="heartbleed_explanation.png" alt="" width="640" height="1364"/></p><p>Heartbleed&rsquo;s operation is not so different than our previously developed example.</p><p>In that example, the <span class="stt">a.out</span> program can be invoked with an argument that specifies the claimed length. As we saw, the length could be wrong! This means that if the attacker is able to run <span class="stt">a.out</span> with a given length that&rsquo;s greater than the actual length of the buffer (i.e., 11 or more), then the attacker can cause the buffer to be read (and written) outside its bounds, accessing nearby memory when that happens.</p><p>In Heartbleed, the attacker (the person, in the XKCD cartoon) acts as the client. It sends a "heartbeat" message to the victim server (the machine, in the cartoon). This message includes some text, and specifies the length of the text. The machine writes the client&rsquo;s text to a buffer and then sends a message back with the contents of the buffer, which contains that text. Crucially, the machine asks the client to specify a length along with the text, and this length can be wrong! Just as with our example, if the specified length is greater than the actual length of the provided text, the server will just send back whatever happens to be in memory beyond the end of the buffer.</p><p>As it turns out, this memory could contain very sensitive information, such as secret cryptographic keys or passwords, perhaps provided by previous clients. Due to OpenSSL&rsquo;s popularity, many Internet servers needed to be shut down and patched, and public cryptographic key certificates that they used to authenticate their identity needed to be reissued, out of fears that exploits of Heartbleed may have stolen them.</p></section><section class="SsectionLevel5" id="section 13.3.5.2"><h5 class="heading">13.3.5.2<span class="stt">&nbsp;</span><a name="(part._.Buffer_.Overwrite__.Morris_.Worm)"></a>Buffer Overwrite: Morris Worm<span class="button-group"><a href="#(part._.Buffer_.Overwrite__.Morris_.Worm)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>The Morris Worm was the work of Robert Morris, a computer science student at Cornell University. <a href="https://spaf.cerias.purdue.edu/tech-reps/823.pdf">Occurring in 1988, it is one of the first widely acknowledged (and impactful) uses of a buffer overflow exploit</a> (in the program <a href="https://en.wikipedia.org/wiki/Finger_protocol">fingerd</a>) for the purposes of injecting code.</p><p>As described in <a href="http://computerarcheology.com/Virus/MorrisWorm/">this article</a>, the exploit worked by sending a larger message to the <span class="stt">fingerd</span> program than it expected to ever receive. In particular, the program pre-allocated a buffer of size 500 in a local variable in <span class="stt">main</span>. The exploit sent to the program an input that filled that buffer with 536 bytes of data &#8212;<wbr></wbr> more than it could hold. As a result, the extra bytes spilled out and overwrote other parts of the call stack, including <span class="stt">main</span>&rsquo;s return address. Therefore, when the <span class="stt">main</span> function completed, instead of properly returning to its caller, it "returned" to an address placed by the attacker.</p><p>Cleverly, the exploit chose to overwrite the return address with a value that pointed <span style="font-style: italic">inside the just-overflowed buffer</span>, so that after the return, the contents of that buffer were treated by the machine as code. This code was also cleverly chosen so that when executed it performs <span class="stt">execve("/bin/sh",0,0)</span>; i.e., it turns the current program into a shell running on the attacked system. This attack came to be known as a <a href="https://inst.eecs.berkeley.edu/~cs161/fa08/papers/stack_smashing.pdf"><span style="font-style: italic">stack smashing attack</span></a> and the attack&rsquo;s payload came to be known as <a href="https://en.wikipedia.org/wiki/Shellcode">shellcode</a>.</p><p>Buffer overwrites are also dangerous even when stack smashing (or similar sorts of code injection attacks) are not possible. Returning to our example, imagine that the variable <span class="stt">z</span> represented a flag that indicates whether a user has been authorized to carry out a sensitive operation. By overflowing buffer <span class="stt">y</span>, an unauthorized user will be granted excess privilege.</p><section class="SsectionLevel6" id="section 13.3.5.2.1"><h5 class="heading">13.3.5.2.1<span class="stt">&nbsp;</span><a name="(part._.Code_.Injection)"></a>Code Injection<span class="button-group"><a href="#(part._.Code_.Injection)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>The Morris Worm exploit aims to perform <span style="font-weight: bold">code injection</span>. It works by tricking the program to treat attacker-provided data as code. Buffer overflows are one vector to doing code injection, where the injected code is machine code. But it is not the only one, as we will see later; others include</p><ul><li><p>SQL injection</p></li><li><p>Command injection</p></li><li><p>Cross-site scripting</p></li><li><p>Use-after-free (violating Temporal Safety)</p></li><li><p>... and many others are a kind of bug, coupled with an exploit that aims to inject code of the attacker&rsquo;s choice.</p></li></ul><p>How can we defeat them?</p></section></section></section></section><section class="SsectionLevel3" id="section 13.4"><h3 class="heading">13.4<span class="stt">&nbsp;</span><a name="(part._.Defense__.Type-safe_.Languages)"></a>Defense: Type-safe Languages<span class="button-group"><a href="#(part._.Defense__.Type-safe_.Languages)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h3><table cellspacing="0" cellpadding="0"><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.Why_.Is_.Type_.Safety_.Helpful_%29" class="toclink" data-pltdoc="x">13.4.1<span class="hspace">&nbsp;</span>Why Is Type Safety Helpful?</a></p></td></tr><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.Costs_of_.Ensuring_.Type_.Safety%29" class="toclink" data-pltdoc="x">13.4.2<span class="hspace">&nbsp;</span>Costs of Ensuring Type Safety</a></p></td></tr></table><p>To recap what we have seen so far about <a href="buffer-overflows.scrbl">buffer overflows</a>:</p><ul><li><p>A buffer overflow is the term for a family of exploits of bugs that allow a buffer to be read or written outside its bounds.</p></li><li><p>A buffer overflow can be used to steal sensitive information (as with Heartbleed) or even to inject and run attacker-provided code (as with the Morris Worm).</p></li></ul><p>We also saw something very interesting: <span style="font-style: italic">Neither of these, nor indeed any other, exploits of buffer overflows are possible in OCaml</span>. Why? Because any attempt to read or write outside the bounds of a buffer is detected immediately, and met with a run-time exception.</p><p>This is a consequence of OCaml being a <span style="font-style: italic"><span style="font-weight: bold">type-safe</span></span> <span style="font-weight: bold">programming language</span>; indeed, the programs written in Java and Ruby are immune from buffer overflows and similar sorts of memory corruption attack, too, since they are also type-safe.</p><section class="SsectionLevel4" id="section 13.4.1"><h4 class="heading">13.4.1<span class="stt">&nbsp;</span><a name="(part._.Why_.Is_.Type_.Safety_.Helpful_)"></a>Why Is Type Safety Helpful?<span class="button-group"><a href="#(part._.Why_.Is_.Type_.Safety_.Helpful_)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p><a href="http://www.pl-enthusiast.net/2014/08/05/type-safety/">Type safety</a> ensures two useful properties that preclude buffer overflows and other memory corruption-based exploits.</p><p>Type safety ensures that memory in use by the program at a particular type <span style="font-style: italic">T</span> <span style="font-style: italic">always</span> has (or can be treated as having) that type <span style="font-style: italic">T</span>. This property, called <span style="font-weight: bold">preservation</span> (aka <span style="font-style: italic">subject reduction</span>), ensures that, for example, if <span class="stt">x</span> is a pointer to an integer (<span class="stt">int ref</span> in OCaml), it will <span style="font-style: italic">always</span> be usable at that type. No action by the program can change <span class="stt">x</span>&rsquo;s contents to break the invariants assumed of values of that type. As a consequence, this means that a pointer-typed value cannot be overwritten to make it something that is not a proper pointer (created by a legitimate program action) to the program&rsquo;s heap or stack.</p><p>In addition, values deemed to have type <span style="font-style: italic">T</span> will be usable by code expecting to receive a value of that type; i.e., the aforementioned invariants of values of a type T are sufficient to ensure safe execution. For example, code expecting to receive an array of integers will not break if it tries to iterate down the array and increment each element, since these operations (reading and writing within the stated bounds of the array, and adding one to an integer) are permitted on objects of this type. This property is called <span style="font-weight: bold">progress</span>.</p><p>To ensure preservation and progress implies that buffers can only be accessed within their allotted bounds, precluding buffer overflows. This is because overwrites could break preservation, since they could end up breaking the assumed invariants of the type of a nearby value. Overreads could break progress, since an out-of-bounds read may return memory that does not conform to the invariants of the expected type (e.g., reading an out of the bounds of an array of integer pointers may return gibberish and not a proper pointer).</p><p>Type safety turns out to preclude other pernicious exploits, too, that work by corrupting memory. These include <span style="font-weight: bold">use after free</span> (an example of which we give below), <a href="https://owasp.org/www-community/attacks/Format_string_attack"><span style="font-weight: bold">format string attacks</span></a>, and <a href="https://www.microsoft.com/security/blog/2015/06/17/understanding-type-confusion-vulnerabilities-cve-2015-0336/"><span style="font-weight: bold">type confusion</span></a>, among others. These exploits attempt to force memory created at type <span style="font-style: italic">T</span> to be used at another type <span style="font-style: italic">S</span> instead. By enforcing type safety, the language ensures these attacks can&rsquo;t happen. This is good for program security, and it&rsquo;s also good for program reliability and even programmer productivity, since type safety rules out many sorts of hard-to-find bugs that make a program prone to crashing.</p></section><section class="SsectionLevel4" id="section 13.4.2"><h4 class="heading">13.4.2<span class="stt">&nbsp;</span><a name="(part._.Costs_of_.Ensuring_.Type_.Safety)"></a>Costs of Ensuring Type Safety<span class="button-group"><a href="#(part._.Costs_of_.Ensuring_.Type_.Safety)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>C and C++ are the only programming languages in common use that eschew type safety. Why do they do this? There are two commonly cited reasons, <span style="font-weight: bold">performance</span> and <span style="font-weight: bold">expressiveness</span>. There are two direct forms of performance slowdown typical of type-safe languages: <span style="font-weight: bold">bounds checks</span> and <span style="font-weight: bold">garbage collection</span>.</p><section class="SsectionLevel5" id="section 13.4.2.1"><h5 class="heading">13.4.2.1<span class="stt">&nbsp;</span><a name="(part._.Array_.Bounds_.Checks_for_.Spatial_.Safety)"></a>Array Bounds Checks for Spatial Safety<span class="button-group"><a href="#(part._.Array_.Bounds_.Checks_for_.Spatial_.Safety)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>Run-time checks to ensure that buffer accesses are in bounds (thus enforcing <span style="font-style: italic">spatial safety</span>) add overhead to a program&rsquo;s running time. If these checks occur in a tight loop, their impact is multiplied. Reconsider our OCaml example:</p><p><div class='fancy-box'><div class="sourceCode" id="cb1"><pre
class="sourceCode ocaml"><code class="sourceCode ocaml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="kw">rec</span> incr_arr x i len =</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> i &gt;= <span class="dv">0</span> &amp;&amp; i &lt; len <span class="kw">then</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    (x.(i) &lt;- x.(i) + <span class="dv">1</span>;</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    incr_arr x (i+<span class="dv">1</span>) len)</span></code></pre></div>
</div></p><p>In principle, safely executing <span class="stt">x.(i)</span> in <span class="stt">incr_arr</span> requires the compiler to add a lower-bound check and an upper-bound check, to confirm that <span class="stt">i &gt;= 0</span> and <span class="stt">i &lt;</span> <span style="font-style: italic">length(</span><span class="stt">x</span><span style="font-style: italic">).</span> This pair of checks will be inserted for each <span class="stt">x.(i)</span> occurring on line 3, i.e., for both the read and the write. Since not much else is happening in the loop, the bounds checks could dominate running time.</p><p>Fortunately, it is now common for a compiler to avoid inserting bounds checks when it can prove they are not needed. This is true of ahead-of-time compilers for languages like OCaml, and the <a href="https://en.wikipedia.org/wiki/Just-in-time_compilation">just-in-time compilers</a> that occur inside of language virtual machines, like the Java Virtual Machine (such as <a href="https://docs.oracle.com/javase/9/vm/java-virtual-machine-technology-overview.htm">the one maintained by Oracle</a>) or the Javascript execution engine (e.g., like Google&rsquo;s <a href="https://v8.dev/">V8</a>).</p><p>In our example, the OCaml compiler knows that to reach line 3, the guard on line 2 must have been true and thus that <span class="stt">i &gt;= 0 &amp;&amp; i &lt; len</span>. Knowing this, we can deduce that as long as <span class="stt">len &lt;=</span> <span style="font-style: italic">length(</span><span class="stt">x</span><span style="font-style: italic">)</span>, the access <span class="stt">x.(i)</span> will be in bounds, so this is the check the compiler will insert. Moreover, since neither <span class="stt">i</span> nor <span class="stt">x</span> are changed between the two <span class="stt">x.(i)</span> accesses on line 3, there is no need to perform the check twice: One check will do, just prior to line 3, for both accesses. Such reasoning allows the compiler to replace the four checks it would have inserted with a single one. Here&rsquo;s what the program would look like, if we made the check explicit:</p><p><div class='fancy-box'><div class="sourceCode" id="cb1"><pre
class="sourceCode ocaml"><code class="sourceCode ocaml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="kw">rec</span> incr_arr_with_check x i len =</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> i &gt;= <span class="dv">0</span> &amp;&amp; i &lt; len <span class="kw">then</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> len &lt;= <span class="dt">Array</span>.length x <span class="kw">then</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>       x.(i) &lt;- x.(i) + <span class="dv">1</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>     <span class="kw">else</span> <span class="dt">raise</span> (<span class="dt">Invalid_argument</span> <span class="st">&quot;index out of bounds&quot;</span>);</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    incr_arr_with_check x (i+<span class="dv">1</span>) len)</span></code></pre></div>
</div></p><p>Even this check can be eliminated with a little more work: The compiler just has to add a check that <span class="stt">len &lt;=</span> <span style="font-style: italic">length(</span><span class="stt">x</span><span style="font-style: italic">)</span> prior to the initial call to <span class="stt">incr_arr</span>; it will be trivially true for each of the recursive calls. (And, likewise, if we&rsquo;d written our program as above with an explicit check, the compiler will know that no additional checks will be needed, since we&rsquo;ve done the required checking already.)</p><p>Recent work on an extension to C called <a href="https://www.microsoft.com/en-us/research/project/checked-c/"><span style="font-weight: bold">Checked C</span></a> aims to support bounds checking in C, to avoid buffer overruns. Preliminary work (in <a href="http://www.cs.umd.edu/~mwh/papers/checked-c.pdf">2018</a> and <a href="https://cs.rochester.edu/u/jzhou41/papers/freebsd_checkedc.pdf">2020</a>) has shown that running time overhead due to bounds checks can be reduced to just a few percent, on average, if the compiler is smart enough.</p></section><section class="SsectionLevel5" id="section 13.4.2.2"><h5 class="heading">13.4.2.2<span class="stt">&nbsp;</span><a name="(part._.Temporal_.Safety_.Violations)"></a>Temporal Safety Violations<span class="button-group"><a href="#(part._.Temporal_.Safety_.Violations)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>In C and C++ it is the programmer&rsquo;s responsibility to free dynamically allocated memory that is no longer needed, so that it can be recycled. In C, dynamic memory is allocated via a call to <span class="stt">malloc</span>, and this memory is freed by passing its pointer to <span class="stt">free</span>. In C++ one calls <span class="stt">new</span> to allocate an object and <span class="stt">delete</span> to free it. Both calls are typically inexpensive.</p><p>In a type-safe language, manual allocation may be explicit (like <span class="stt">new</span> in Java and Ruby) while programmer-directed deallocation, e.g., via <span class="stt">free</span> or <span class="stt">delete</span>, is generally disallowed (with <a href="../rust/">Rust being a notable exception</a>). This is because prematurely deallocating memory can compromise safety, in particular <span style="font-style: italic">temporal safety</span>. To see why, consider the following C program.</p><p><div class='fancy-box'><div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> list <span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> v<span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> list <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> list <span class="op">*</span>p <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> list<span class="op">));</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  p<span class="op">-&gt;</span>v <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  p<span class="op">-&gt;</span>next <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  free<span class="op">(</span>p<span class="op">);</span> <span class="co">// deallocates p</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> <span class="op">*</span>x <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">)*</span><span class="dv">2</span><span class="op">);</span> <span class="co">// reuses p&#39;s old memory</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  x<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">5</span><span class="op">;</span> <span class="co">// overwrites p-&gt;v</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  x<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="dv">5</span><span class="op">;</span> <span class="co">// overwrites p-&gt;next</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  p <span class="op">=</span> p<span class="op">-&gt;</span>next<span class="op">;</span> <span class="co">// p is now bogus</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  p<span class="op">-&gt;</span>v <span class="op">=</span> <span class="dv">2</span><span class="op">;</span> <span class="co">// CRASH!</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div></p><p>The top of the program defines a <span class="stt">struct list</span> for a linked list; the value stored at the list node is in field <span class="stt">v</span>, and the pointer to the next list element is in the <span class="stt">next</span> field. The <span class="stt">main</span> function calls <span class="stt">malloc</span> to allocate a <span class="stt">struct list</span> node, storing a pointer to it in <span class="stt">p</span>, and then lines 8 and 9 initialize the value and next pointer to <span class="stt">0</span> (recall that in C, <span class="stt">0</span> when used as a pointer is equivalent to <span class="stt">null</span> in Java). Line 10 frees this memory, allowing it to be reused.</p><p>Then the trouble begins. Line 11 calls <span class="stt">malloc</span> which is very likely to reuse the just-freed memory. Here, <span class="stt">malloc</span> creates a 2-element <span class="stt">int</span> array, stored in <span class="stt">x</span>, and lines 12 and 13 initialize each of the array&rsquo;s elements to <span class="stt">5</span>. Line 14 is buggy: It uses <span class="stt">p</span> even though <span class="stt">p</span> no longer points to valid memory, since it was freed; <span class="stt">p</span> is called a <span style="font-weight: bold">dangling pointer</span>. Assuming that <span class="stt">x</span> and <span class="stt">p</span> point to the same memory, due to the memory being recycled, <span class="stt">x[0]</span> is now an <span style="font-style: italic">alias</span> for <span class="stt">p-&gt;v</span> and <span class="stt">x[1]</span> is an alias of <span class="stt">p-&gt;next</span>. This means that writing to <span class="stt">x[1]</span> on line 13 overwrites <span class="stt">p-&gt;next</span> with <span class="stt">5</span>. The overwrite on line 13 means that when line 14 updates <span class="stt">p</span> to <span class="stt">p-&gt;next</span> it is setting <span class="stt">p</span> to <span class="stt">5</span>, and when line 15 performs <span class="stt">p-&gt;v</span>, it is dereferencing <span class="stt">5</span> as if it were a pointer. Since <span class="stt">5</span> is very unlikely to be a legitimate memory address (usually the lower range of memory is reserved for the operating system), and is certainly not a pointer to a proper <span class="stt">struct list</span> as its type claims, we have violated type safety. On my Mac, if we compile and run this program we see:</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">Segmentation fault: 11</span></p></td></tr></table></p><p>Using a pointer after it is freed is a bug that can be (and frequently is) exploited, e.g., to perform code injection. Such an exploit is, aptly, referred to as a <a href="https://owasp.org/www-community/vulnerabilities/Using_freed_memory"><span style="font-weight: bold">use after free</span></a>. Such exploits are not possible in a type-safe language, which the language usually ensures by precluding calls to <span class="stt">free</span> entirely. If you can&rsquo;t call <span class="stt">free</span> to deallocate the memory, you can&rsquo;t deallocate it prematurely! But if we are not allowed to call <span class="stt">free</span> how do we avoid running out of usable memory?</p></section><section class="SsectionLevel5" id="section 13.4.2.3"><h5 class="heading">13.4.2.3<span class="stt">&nbsp;</span><a name="(part._.Garbage_.Collection)"></a>Garbage Collection<span class="button-group"><a href="#(part._.Garbage_.Collection)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p><a href="https://www.cs.kent.ac.uk/people/staff/rej/gc.html">Garbage collection (GC)</a> is, generally speaking, an automatic process by which dynamically allocated memory that the program no longer needs is identified and recycled. A GC works by reclaiming any objects that are not <span style="font-style: italic">reachable</span> by the actively running program. A reachable object is one that can be accessed via a chain of pointers, starting from a local or global variable. A reachable object <span style="font-style: italic">may</span> be accessed by the program in the future, so it&rsquo;s not safe to get rid of it. On the other hand, an unreachable object will <span style="font-style: italic">never</span> be accessed, since there&rsquo;s no path to it from any in-scope variables; hence, it&rsquo;s safe to remove.</p><p>Reachability is typically determined by one of two methods: <span style="font-weight: bold">tracing</span> or <span style="font-weight: bold">reference counting</span>.</p><p>A tracing GC determines reachability directly: Starting from the local and global variables (the "roots"), the GC follows any pointers it comes across, ultimately identifying all of the reachable memory objects. Unreached objects are recycled.</p><p>Reference counting determines reachability incrementally, as the program runs: Along with each object is stored a hidden <span style="font-style: italic">reference count</span> field, which keeps track of the number of direct pointers to the object that exist in the program. Every time a pointer is updated to point to an object, that object&rsquo;s reference count is incremented. When a pointer to an object is dropped, e.g., by the program changing the pointer or it going out of scope and/or being freed, the count is decremented. When a count goes to zero, the object is garbage and can be recycled.</p><p>Garbage collection helps ensure type safety by avoiding the use-after-free bugs we saw before: No object will be freed if it could be used again in the future. This is good for security, and it&rsquo;s also good for ease of use&#8212;<wbr></wbr>figuring out when to free an object is one less thing the programmer needs to worry about.</p><p>On the other hand, GC adds extra performance overheads. A tracing collector adds to the program&rsquo;s running time the cost of periodically tracing the program&rsquo;s memory and collecting the unreachable objects. Tracing is also problematic for performance because the program is paused while it takes place. Tracing collectors can reduce running time overhead by delaying when tracing takes place, but doing so adds space overhead&#8212;<wbr></wbr>the longer you wait to trace, the more garbage there is taking up potentially valuable memory. In <a href="https://docs.oracle.com/javase/10/gctuning/introduction-garbage-collection-tuning.htm">more advanced GCs</a>, tracing can also be done in parallel, to speed up GC while the program is paused, and/or concurrently with the program while it runs, thus slowing its progress but not stopping it during GC.</p><p>A reference counting collector avoids this long pause but still adds overhead for maintaining reference counts (and can result in a periodic pause if there are cascading deletes). Reference counting also adds a per-object space overhead, due to having to store the count.</p><p>The time and space overheads of garbage collection are often perfectly acceptable, given the productivity and security benefits GC offers. This fact is evidenced by the vast number of programs now written in garbage collected languages; back in the early to mid 90s, GC was a dirty word in many circles! But there are some circumstances for which performance is at a premium, and in these circumstances there is resistance to moving away from C and C++, despite the risks.</p></section><section class="SsectionLevel5" id="section 13.4.2.4"><h5 class="heading">13.4.2.4<span class="stt">&nbsp;</span><a name="(part._.Expressiveness)"></a>Expressiveness<span class="button-group"><a href="#(part._.Expressiveness)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>Type safety, as we have seen, is often enforced by limiting the operations allowed on particular objects to ones that (always) ensure progress and preservation (and, usually, a form of <a href="https://blog.sigplan.org/2019/10/17/what-type-soundness-theorem-do-you-really-want-to-prove/">type abstraction</a>, which we won&rsquo;t get into). This means that type safety can sacrifice needed expressiveness in some cases.</p><p>For example, the C programming language was originally invented at AT&amp;T Bell Labs to enable writing the UNIX operating system in a high-level language (i.e., not machine code). In operating system code, you are interacting with the underlying hardware. You may know that a particular hardware address must store a pointer to a structure, say the page tables; the operating system needs to be able to store this pointer at that address. So, the OS code casts that address to a pointer to a <span class="stt">struct</span> that describes the format of the page tables.</p><p>This sort of operation&#8212;<wbr></wbr>cast from integer to pointer&#8212;<wbr></wbr>is not permitted in a type safe language. We have already seen why: Not every integer is a legal pointer, and the unfettered cast permits many dangerous operations. But in the OS context, we need to allow this sort of thing at least sometimes. So, C was designed to afford programmers more freedom to perform potentially dangerous actions.</p><p>C similarly permits casting between different sorts of objects, e.g., a <span class="stt">struct</span> and an array. We do this during calls to <span class="stt">memcpy</span>, for example, which takes a pointer to a buffer:</p><p><div class='fancy-box'><div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> foo <span class="op">{</span> <span class="dt">int</span> x<span class="op">;</span> <span class="dt">int</span> y<span class="op">;</span> <span class="op">};</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> f<span class="op">(</span><span class="kw">struct</span> foo <span class="op">*</span>p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> foo s<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  memcpy<span class="op">(&amp;</span>s<span class="op">,</span>p<span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> foo<span class="op">));</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div></p><p>The alternative of copying a <span class="stt">struct</span> field by field might be slower than bulk copy via <span class="stt">memcpy</span>.</p><p>Interestingly, there are many other uses of casts in C that are common, but are <a href="https://dl.acm.org/doi/10.1145/3290380">technically not supported by the language definition</a>. But in any case, most compilers support them.</p><section class="SsectionLevel6" id="section 13.4.2.4.1"><h5 class="heading">13.4.2.4.1<span class="stt">&nbsp;</span><a name="(part._.Unsafe_code_via_.Escape_.Hatches)"></a>Unsafe code via Escape Hatches<span class="button-group"><a href="#(part._.Unsafe_code_via_.Escape_.Hatches)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>One way that type-safe languages work around expressiveness problems is to have "escape hatches" that allow potentially unsafe operations. In OCaml, for example, you can call into C code to do your dirty work, using the <a href="https://caml.inria.fr/pub/docs/manual-ocaml/intfc.html">OCaml Foreign Function Interface</a>. Or, if you know enough about OCaml representations, you can even do unsafe things in OCaml itself via <span class="stt">Obj.magic</span>, part of the <a href="https://caml.inria.fr/pub/docs/manual-ocaml/libref/Obj.html">Obj module</a>.</p></section></section></section></section><section class="SsectionLevel3" id="section 13.5"><h3 class="heading">13.5<span class="stt">&nbsp;</span><a name="(part._.Command_.Injection)"></a>Command Injection<span class="button-group"><a href="#(part._.Command_.Injection)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h3><table cellspacing="0" cellpadding="0"><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.What_s_.Wrong_with_this_.Ruby_.Code_%29" class="toclink" data-pltdoc="x">13.5.1<span class="hspace">&nbsp;</span>What&rsquo;s Wrong with this Ruby Code?</a></p></td></tr><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.When_could_this_be_bad_%29" class="toclink" data-pltdoc="x">13.5.2<span class="hspace">&nbsp;</span>When could this be bad?</a></p></td></tr></table><p>A type-safe language will rule out the possibility of buffer overflow exploits, and this is an important benefit. Unfortunately, type safety will not rule out all forms of attack.</p><p>In this unit we&rsquo;ll talk about <a href="https://owasp.org/www-community/attacks/Command_Injection"><span style="font-weight: bold">command injection</span></a> as another form of code injection attack, but one that requires a bit more programmer vigilance to prevent.</p><section class="SsectionLevel4" id="section 13.5.1"><h4 class="heading">13.5.1<span class="stt">&nbsp;</span><a name="(part._.What_s_.Wrong_with_this_.Ruby_.Code_)"></a>What&rsquo;s Wrong with this Ruby Code?<span class="button-group"><a href="#(part._.What_s_.Wrong_with_this_.Ruby_.Code_)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>The following is the program <span class="stt">catwrapper.rb</span>, written in Ruby.</p><p><div class='fancy-box'><div class="sourceCode" id="cb1"><pre
class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="cn">ARGV</span><span class="at">.length</span> <span class="op">&lt;</span> <span class="dv">1</span> <span class="cf">then</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">puts</span> <span class="st">&quot;required argument: textfile path&quot;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exit</span> <span class="dv">1</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># call cat command on given argument</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(<span class="st">&quot;cat &quot;</span><span class="op">+</span><span class="cn">ARGV</span><span class="kw">[</span><span class="dv">0</span><span class="kw">]</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">exit</span> <span class="dv">0</span></span></code></pre></div>
</div></p><p>The intention of this program is simply to call the system <span class="stt">cat</span> command to print out the contents of the argument that was passed to the program (line 7). If no argument is passed, the program prints an error message and exits (lines 1-4).</p><p>Here&rsquo;s an interactive shell session, running the program:</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">&gt; ls</span></p></td></tr><tr><td><p><span class="stt">catwrapper.rb</span></p></td></tr><tr><td><p><span class="stt">hello.txt</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; ruby catwrapper.rb hello.txt</span></p></td></tr><tr><td><p><span class="stt">Hello world!</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; ruby catwrapper.rb catwrapper.rb</span></p></td></tr><tr><td><p><span class="stt">if ARGV.length &lt; 1 then</span></p></td></tr><tr><td><p><span class="stt">puts "required argument: textfile path"</span></p></td></tr><tr><td><p><span class="stt">...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; ruby catwrapper.rb "hello.txt; rm hello.txt"</span></p></td></tr><tr><td><p><span class="stt">Hello world!</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; ls</span></p></td></tr><tr><td><p><span class="stt">catwrapper.rb</span></p></td></tr></table></p><p>First, we call <span class="stt">ls</span> to list the contents of the current working directory (lines 1-3). We see the <span class="stt">catwrapper.rb</span> program itself, and a file <span class="stt">hello.txt</span>. Then we execute <span class="stt">ruby catwrapper.rb hello.txt</span> &#8212;<wbr></wbr> this runs the <span class="stt">catwrapper.rb</span> program with <span class="stt">hello.txt</span> as its argument, and the result is that <span class="stt">cat hello.txt</span> is called, which prints the contents of that file (lines 5-6). Then we call <span class="stt">catwrapper.rb</span> on itself, which causes its own code to be printed (lines 8-11). The next command is the most interesting: the argument to <span class="stt">catwrapper.rb</span> is <span class="stt">"hello.txt; rm hello.txt"</span>, which looks unusual. The program doesn&rsquo;t reject this argument and prints out the contents of <span class="stt">hello.txt</span> as before. But on line 16 when we <span class="stt">ls</span> the directory we see that <span class="stt">hello.txt</span> is no longer there. What happened?</p><section class="SsectionLevel5" id="section 13.5.1.1"><h5 class="heading">13.5.1.1<span class="stt">&nbsp;</span><a name="(part._.The_.Answer)"></a>The Answer<span class="button-group"><a href="#(part._.The_.Answer)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>What happened is that the Ruby <span class="stt">system()</span> command (line 7 in <span class="stt">catwrapper.rb</span>) interpreted the string <span class="stt">ARGV[0]</span> as having two commands, and executed them both! That is, when calling <span class="stt">catwrapper.rb</span> with <span class="stt">"hello.txt; rm hello.txt"</span> we end up invoking <span class="stt">system("cat hello.txt; rm hello.txt")</span>. This means that we will <span class="stt">cat</span> (print) the contents of <span class="stt">hello.txt</span> but then remove it!</p><p>This was likely not our intention in writing <span class="stt">catwrapper.rb</span>. Instead, we were simply interested in printing the contents of a file, passed as an argument. Rather than implement this functionality from scratch we used the existing <span class="stt">cat</span> program. This is all well and good. But the way we invoked <span class="stt">cat</span>, via <span class="stt">system()</span>, allowed for problems that we didn&rsquo;t appreciate.</p></section></section><section class="SsectionLevel4" id="section 13.5.2"><h4 class="heading">13.5.2<span class="stt">&nbsp;</span><a name="(part._.When_could_this_be_bad_)"></a>When could this be bad?<span class="button-group"><a href="#(part._.When_could_this_be_bad_)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>If <span class="stt">catwrapper.rb</span> is just a program that we use in our own work, then it&rsquo;s not a big deal. We are not going to pass it weird arguments. But suppose that <span class="stt">catwrapper.rb</span> ends up getting incorporated into a web service, e.g., in a <a href="https://rubyonrails.org/">Ruby on Rails</a> web application. Perhaps a client browser can send a request to the server and this request is translated directly into an argument to <span class="stt">catwrapper.rb</span>, whose output is then sent back to the client.</p><p>Now a malicious user in a far-flung place in the world could send the input <span class="stt">"hello.txt; rm hello.txt"</span> and thereby corrupt the filesystem on the web server.</p><p>The problem is that the input given to <span class="stt">catwrapper.rb</span> in the web server context is <span style="font-style: italic">untrusted;</span> we cannot assume well-meaning clients, so we must allow for the possibility that the input could be absolutely anything. If we want clients only to be able to see the contents of files, then the current code is too powerful. The fix? We need to add code to <span style="font-weight: bold">validate the inputs</span>.</p><section class="SsectionLevel5" id="section 13.5.2.1"><h5 class="heading">13.5.2.1<span class="stt">&nbsp;</span><a name="(part._.Command_.Injection_is_.Code_.Injection)"></a>Command Injection is Code Injection<span class="button-group"><a href="#(part._.Command_.Injection_is_.Code_.Injection)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>As with the stack smashing attack we discussed in the context of buffer overflows, command injection is a kind of code injection attack. In both cases, the program expects to receive and process data, but the adversary is able to trick the program to treat received data as code. For stack smashing, this is machine code. For command injection, it is shell commands.</p></section></section></section><section class="SsectionLevel3" id="section 13.6"><h3 class="heading">13.6<span class="stt">&nbsp;</span><a name="(part._.Defense__.Input_.Validation)"></a>Defense: Input Validation<span class="button-group"><a href="#(part._.Defense__.Input_.Validation)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h3><table cellspacing="0" cellpadding="0"><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._.Checking_and_.Sanitization%29" class="toclink" data-pltdoc="x">13.6.1<span class="hspace">&nbsp;</span>Checking and Sanitization</a></p></td></tr><tr><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28part._security-summary%29" class="toclink" data-pltdoc="x">13.6.2<span class="hspace">&nbsp;</span>Summary</a></p></td></tr></table><p>Summarizing what we have learned so far, there are two core elements that make a command injection exploit a real threat:</p><ul><li><p>There are possible, though atypical, inputs that could cause our program to do something illegal</p></li><li><p>Such atypical inputs are more likely when an untrusted adversary is providing them</p></li></ul><p>The same two elements are present for buffer overflow exploits, too. With the Morris worm, the <span class="stt">fingerd</span> program would accept any string as input, but strings over 500 characters in length would overrun the input buffer, and particular choices of string could induce (very) bad behavior. Such inputs would be atypical when coming from a normal (trusted) user, but were possible (and happened!) when coming from an adversary.</p><p>A type-safe language makes the problematic inputs for a buffer overflow impossible: Any attempt to go outside the buffer is blocked by the language. But with command injection the language does not help us. So, what can we do? We must add code to <span style="font-weight: bold">validate the inputs</span>.</p><section class="SsectionLevel4" id="section 13.6.1"><h4 class="heading">13.6.1<span class="stt">&nbsp;</span><a name="(part._.Checking_and_.Sanitization)"></a>Checking and Sanitization<span class="button-group"><a href="#(part._.Checking_and_.Sanitization)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p><span style="font-style: italic">Input validation</span> refers to a process of making an input <span style="font-style: italic">valid for use</span>, meaning that it cannot possibly result in harm if provided to our service. A valid input will be a subset of all possible inputs that a user (including a malicious one) could provide. For our <span class="stt">catwrapper.rb</span> example, valid inputs are, ultimately, names of files whose contents a particular user is allowed to see. Since <span class="stt">"hello.txt; rm hello.txt"</span> is not the name of a valid file, it is not a valid input.</p><p>There are two general ways we can write a program to ensure inputs to it are valid:</p><ul><li><p>We can <span style="font-style: italic">check</span> that inputs match the desired form. If they do not then they are rejected and the program proceeds no further.</p></li><li><p>We can force inputs to match the desired form by modifying them, if necessary, before proceeding. Modifying a potentially invalid input so it becomes a valid one is called <span style="font-style: italic">sanitization</span>.</p></li></ul><p>There are three kinds of input validation in common use: <span style="font-weight: bold">blacklisting</span>, <span style="font-weight: bold">escaping</span>, and <span style="font-weight: bold">whitelisting</span>.</p><section class="SsectionLevel5" id="section 13.6.1.1"><h5 class="heading">13.6.1.1<span class="stt">&nbsp;</span><a name="(part._.Blacklisting)"></a>Blacklisting<span class="button-group"><a href="#(part._.Blacklisting)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>Blacklisting works by preventing inputs that include features that could make it dangerous. Blacklisting has variants involving either checking or sanitization.</p><section class="SsectionLevel6" id="section 13.6.1.1.1"><h5 class="heading">13.6.1.1.1<span class="stt">&nbsp;</span><a name="(part._.Checking)"></a>Checking<span class="button-group"><a href="#(part._.Checking)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>For example, we could replace the call <span class="stt">system("cat "+ARGV[0])</span> in our <span class="stt">catwrapper.rb</span> program to be the following.</p><p><div class='fancy-box'><div class="sourceCode" id="cb1"><pre
class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="cn">ARGV</span><span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="op">=~</span> <span class="ss">/;/</span> <span class="cf">then</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">puts</span> <span class="st">&quot;illegal argument&quot;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exit</span> <span class="dv">1</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system</span>(<span class="st">&quot;cat &quot;</span><span class="op">+</span><span class="cn">ARGV</span><span class="kw">[</span><span class="dv">0</span><span class="kw">]</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
</div></p><p>The first line checks the argument passed to the program <span class="stt">ARGV[0]</span> against a regular expression that matches any string that has a semicolon (<span class="stt">;</span>) in it. If the argument matches the regular expression it is rejected, which blocks the attack that we saw previously.</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">&gt; ruby catwrapper.rb "hello.txt; rm hello.txt"</span></p></td></tr><tr><td><p><span class="stt">illegal argument</span></p></td></tr></table></p></section><section class="SsectionLevel6" id="section 13.6.1.1.2"><h5 class="heading">13.6.1.1.2<span class="stt">&nbsp;</span><a name="(part._.Sanitization)"></a>Sanitization<span class="button-group"><a href="#(part._.Sanitization)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>Rather than checking and rejecting a problematic input, we could sanitize the input to conform to our well-formedness condition. So we could replace the above 6-line code fragment that rejects those inputs containing a semicolon with the following line of code, which simply removes any semicolons present.</p><p><div class='fancy-box'><div class="sourceCode" id="cb1"><pre
class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(<span class="st">&quot;cat &quot;</span><span class="op">+</span><span class="cn">ARGV</span><span class="kw">[</span><span class="dv">0</span><span class="kw">]</span><span class="at">.tr</span>(<span class="st">&quot;;&quot;</span>,<span class="st">&quot;&quot;</span>))</span></code></pre></div>
</div></p><p>If we run this version of <span class="stt">catwrapper.rb</span> with our problematic input, we get the following.</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">&gt; ruby catwrapper.rb "hello.txt; rm hello.txt"</span></p></td></tr><tr><td><p><span class="stt">Hello world!</span></p></td></tr><tr><td><p><span class="stt">cat: rm: No such file or directory</span></p></td></tr><tr><td><p><span class="stt">Hello world!</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; ls hello.txt</span></p></td></tr><tr><td><p><span class="stt">hello.txt</span></p></td></tr></table></p><p>Since the semicolon from the input is removed, the call to <span class="stt">system</span> ends up being <span class="stt">system("cat hello.txt rm hello.txt")</span>. When the <span class="stt">cat</span> program is given multiple arguments, it prints them out in sequence. Here, <span class="stt">cat</span> thinks it is being asked to print three files, <span class="stt">hello.txt</span>, <span class="stt">rm</span>, and <span class="stt">hello.txt</span> again. The first and third arguments name a valid file in the current directory, so its contents are printed (twice). But <span class="stt">rm</span> is not a file in the current directory, so <span class="stt">cat</span> complains: <span class="stt">rm: No such file or directory</span>.</p><p>This example illustrates that while sanitization may permit accepting more inputs, one drawback is that bogus inputs can lead to confusing error messages going back to the user.</p></section></section><section class="SsectionLevel5" id="section 13.6.1.2"><h5 class="heading">13.6.1.2<span class="stt">&nbsp;</span><a name="(part._.Escaping)"></a>Escaping<span class="button-group"><a href="#(part._.Escaping)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p><span style="font-style: italic">Escaping</span> is a kind of input sanitization that replaces potentially problematic input characters with benign ones (rather than, say, removing them, as with blacklisting). Just as with the checking variant of blacklisting, we can specify problematic characters to find and replace using a regular expression. Here&rsquo;s a replacement for the call <span class="stt">system("cat "+ARGV[0])</span> in our original <span class="stt">catwrapper.rb</span> program that does escaping first.</p><p><div class='fancy-box'><div class="sourceCode" id="cb1"><pre
class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> escape_chars(string)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  pat <span class="op">=</span> <span class="ss">/(</span><span class="sc">\&#39;</span><span class="ss">|</span><span class="sc">\&quot;</span><span class="ss">|</span><span class="sc">\.</span><span class="ss">|</span><span class="sc">\*</span><span class="ss">|</span><span class="sc">\/</span><span class="ss">|</span><span class="sc">\-</span><span class="ss">|</span><span class="sc">\\</span><span class="ss">|;|</span><span class="sc">\|</span><span class="ss">|</span><span class="sc">\s</span><span class="ss">)/</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  string<span class="at">.gsub</span>(pat)<span class="op">{</span> <span class="op">|</span>match<span class="op">|</span> <span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span> <span class="op">+</span> match <span class="op">}</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(<span class="st">&quot;cat &quot;</span><span class="op">+</span>escape_chars(<span class="cn">ARGV</span><span class="kw">[</span><span class="dv">0</span><span class="kw">]</span>))</span></code></pre></div>
</div></p><p>The <span class="stt">escape_chars</span> function takes argument <span class="stt">string</span> and uses the <span class="stt">gsub</span> function to replace substring matches of regular expression <span class="stt">pat</span> with the matched substring <span class="stt">match</span> preceded by a double-backslash (<span class="stt">"\\"</span>). For example:</p><ul><li><p><span class="stt">escape_chars("hello")</span> returns <span class="stt">"hello"</span></p></li><li><p><span class="stt">escape_chars("hello there")</span> returns <span class="stt">"hello\ there"</span></p></li><li><p><span class="stt">escape_chars("rm -rf ../")</span> returns <span class="stt">"rm\ \-rf\ \.\.\/\"</span></p></li></ul><p>Running our modified <span class="stt">catwrapper.rb</span> program with the original exploit, we get the following.</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">&gt; ruby catwrapper.rb "hello.txt; rm hello.txt"</span></p></td></tr><tr><td><p><span class="stt">cat: hello.txt; rm hello.txt: No such file or directory</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; ls hello.txt</span></p></td></tr><tr><td><p><span class="stt">hello.txt</span></p></td></tr></table></p><p>What happened? The <span class="stt">system</span> command ends up being called with the string <span class="stt">"cat hello\\.txt\\;\\ rm\\ hello\\.txt"</span>. The <span class="stt">system</span> command interprets this string as a shell command with escaping applied, so that it treats the sequence <span class="stt">\\</span> as an escaped backslash. It therefore strips each leading backslash so that what is passed to the shell to be executed is <span class="stt">"cat hello\.txt\;\ rm\ hello\.txt"</span>. To the shell, <span class="stt">hello\.txt\;\ rm\ hello\.txt</span> is interpreted as a single argument to <span class="stt">cat</span>, since all spaces are preceded by a backslash. So <span class="stt">cat</span> treats the argument as a file whose name has spaces in it. The error message above indicates that this file is not found, as expected.</p><section class="SsectionLevel6" id="section 13.6.1.2.1"><h5 class="heading">13.6.1.2.1<span class="stt">&nbsp;</span><a name="(part._.Escaping_is_.Language_.Specific)"></a>Escaping is Language Specific<span class="button-group"><a href="#(part._.Escaping_is_.Language_.Specific)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>In our example we are creating a shell program to pass to the <span class="stt">system</span> command, which interprets that program. We are escaping characters that might otherwise be treated as code by the <span class="stt">system</span> command and the shell interpreter to be treated as data instead. What characters may be mistaken as code is language specific, so there is not a one-size-fits-all escaping process.</p><p>There are standard escaping functions on a per-language basis. For example, Ruby&rsquo;s <span class="stt">CGI::escape(str)</span> function will escape <span class="stt">str</span> so it can safely appear in a URI, e.g., <span class="stt">CGI::escape("</span><span class="stt">&rsquo;</span><span class="stt">Stop!</span><span class="stt">&rsquo;</span><span class="stt"> said Fred")</span> becomes <span class="stt">"%27Stop%21%27+said+Fred"</span>. We will see later on the notion of a <span style="font-style: italic">prepared statement</span> for SQL queries; SQL is a programming language for accessing the contents of a database. In essence, the process of putting together a prepared statement is tantamount to escaping user input so that it is not misinterpreted as SQL code.</p></section></section><section class="SsectionLevel5" id="section 13.6.1.3"><h5 class="heading">13.6.1.3<span class="stt">&nbsp;</span><a name="(part._.Whitelisting)"></a>Whitelisting<span class="button-group"><a href="#(part._.Whitelisting)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>Whitelisting is a form of checking&#8212;<wbr></wbr>rather than checking that bad characters are <span style="font-style: italic">not</span> present, it confirms that only <span style="font-style: italic">good</span> characters are.</p><section class="SsectionLevel6" id="section 13.6.1.3.1"><h5 class="heading">13.6.1.3.1<span class="stt">&nbsp;</span><a name="(part._.Motivation)"></a>Motivation<span class="button-group"><a href="#(part._.Motivation)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>Why use whitelisting? One challenge with both blacklisting and escaping is making sure that you identified all of the dangerous characters. In our example <span class="stt">escape_chars</span> function, for example, we left out <span class="stt">&amp;</span> from the <span class="stt">pat</span> regular expression. Since this character is not escaped, if provided in the input to <span class="stt">catwrapper.rb</span> it will be interpreted as code, directing the shell to "run in the background."</p><p>Escaping also has the problem that it doesn&rsquo;t always render command characters harmless. For example, suppose in the following we use the form of <span class="stt">catwrapper.rb</span> with our <span class="stt">escape_chars</span> function.</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">&gt; ls ../passwd.txt</span></p></td></tr><tr><td><p><span class="stt">passwd.txt</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">&gt; ruby catwrapper.rb "../passwd.txt"</span></p></td></tr><tr><td><p><span class="stt">bob:apassword</span></p></td></tr><tr><td><p><span class="stt">alice:anotherpassword</span></p></td></tr></table></p><p>Despite escaping the <span class="stt">.</span> and <span class="stt">/</span> characters, <span class="stt">catwrapper.rb</span> still dutifully follows the path to directory one level up from where it is run and prints the contents of the <span class="stt">passwd.txt</span> file.</p><p>A web service for <span class="stt">catwrapper.rb</span> probably only intends to give access to the files in the current directory; the <span class="stt">../</span> sequence should have been disallowed, but escaping was not up to the task of doing so. A failure to disallow it is called a <a href="https://owasp.org/www-community/attacks/Path_Traversal"><span style="font-weight: bold">Path Traversal</span></a> vulnerability. Using blacklisting to filter out <span class="stt">..</span> sequences is one solution. (But, perhaps filtering out <span class="stt">..</span> would unnecessarily disallow paths like <span class="stt">foo/../hello.txt</span> where <span class="stt">foo</span> is a subdirectory in the current working directory.)</p></section><section class="SsectionLevel6" id="section 13.6.1.3.2"><h5 class="heading">13.6.1.3.2<span class="stt">&nbsp;</span><a name="(part._.Making_.Sure_.Input_is_.Good__not_.Bad_)"></a>Making Sure Input is Good (not Bad)<span class="button-group"><a href="#(part._.Making_.Sure_.Input_is_.Good__not_.Bad_)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h5><p>Whitelisting checks that the input is <span style="font-style: italic">known to be safe</span> rather than just known to be unsafe. For <span class="stt">catwrapper.rb</span>, we only want those files that exactly match a filename in the current directory.</p><p><div class='fancy-box'><div class="sourceCode" id="cb1"><pre
class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> <span class="dt">Dir</span><span class="at">.entries</span>(<span class="st">&quot;.&quot;</span>)<span class="at">.reject</span> <span class="op">{|</span>f<span class="op">|</span> <span class="dt">File</span><span class="at">.directory?</span>(f) <span class="op">}</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="cf">not</span> (files<span class="at">.member?</span> <span class="cn">ARGV</span><span class="kw">[</span><span class="dv">0</span><span class="kw">]</span>) <span class="cf">then</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">puts</span> <span class="st">&quot;illegal argument&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exit</span> <span class="dv">1</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system</span>(<span class="st">&quot;cat &quot;</span><span class="op">+</span><span class="cn">ARGV</span><span class="kw">[</span><span class="dv">0</span><span class="kw">]</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
</div></p><p>The above code rejects inputs that do not mention a legal file name.</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">&gt; ruby catwrapper.rb "hello.txt; rm hello.txt"</span></p></td></tr><tr><td><p><span class="stt">illegal argument</span></p></td></tr></table></p><p>The rationale for whitelisting is that given an input, it is safest to reject it unless we have evidence that it&rsquo;s OK. This is the principle of <span style="font-style: italic">fail-safe defaults</span>. Attempts to just reject known-bad inputs may miss ones we don&rsquo;t know about, and attempts to fix known-bad inputs may produce inputs that result in wrong output, or even permit exploits.</p><p>Whitelisting is not a panacea. It may be expensive to compute the whitelist at runtime&#8212;<wbr></wbr>getting the list of valid files is not cheap. A whitelist may also be hard or impossible to describe (e.g., "all possible proper names"). But from a security perspective a whitelist is preferred when possible, since it&rsquo;s the safest alternative.</p></section></section></section><section class="SsectionLevel4" id="section 13.6.2"><h4 class="heading">13.6.2<span class="stt">&nbsp;</span><a name="(part._security-summary)"></a>Summary<span class="button-group"><a href="#(part._security-summary)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>To sum up: Input validation is needed when not all of the <span style="font-style: italic">possible</span> inputs to a piece of code are sure to be <span style="font-style: italic">safe</span> inputs.</p><p>Any inputs arriving from the outside world, which could be from an untrusted or adversarial party, should be treated with suspicion. Any code that directly consumes such inputs should be scrutinized, as should code that subsequently processes outside inputs. The <span style="font-style: italic">taint</span> of adversarial influence could, without care, propagate through a system to files, databases, etc. and subsequently harm future interactions.</p><p>Input validation&#8212;<wbr></wbr>in the form of blacklisting, escaping, and whitelisting&#8212;<wbr></wbr>can make sure that untrusted input is made safe.</p></section></section></section><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;<span class="tocsettoggle">&nbsp;&nbsp;<a href="javascript:void(0);" title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span></span><span class="navright">&nbsp;&nbsp;<a href="Rust.html" title="backward to &quot;12 Rust&quot;" data-pltdoc="x" rel="prev">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;CMSC 330 Lecture Notes&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="exercises.html" title="forward to &quot;14 Exercises&quot;" data-pltdoc="x" rel="next">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>